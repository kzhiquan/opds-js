OPDS.Entry=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser();this.rawDoc=null},extend:{fromJQuery:function(b,a){var c=new OPDS.Entry(a);c.rawDoc=b;c.serialize();return c}},serialize:function(){if(this.rawDoc.find("entry").length==1){this.rawDoc=this.rawDoc.find("entry")}this.title=this.rawDoc.find("title").text()||null;this.id=this.rawDoc.find("id").text()||null;this.summary=this.rawDoc.find("summary").text()||null;this.content=this.rawDoc.find("content").text()||null;this.rights=this.rawDoc.find("rights").text()||null;this.subtitle=this.rawDoc.find("subtitle").text()||null;var b=this.rawDoc.find("updated").text();try{this.updated=Date.parse(b)}catch(a){this.updated=null}b=this.rawDoc.find("published").text();try{this.published=Date.parse(b)}catch(a){this.published=null}this.authors=_(this.rawDoc.find("author")).chain().toArray().map(function(c){return{name:this.rawDoc.find("author>name",c).text(),uri:this.rawDoc.find("author>uri",c).text(),email:this.rawDoc.find("author>email",c).text()}},this).value();this.author=_.first(this.authors);this.contributors=_(this.rawDoc.find("contributor")).chain().toArray().map(function(c){return{name:this.rawDoc.find("contributor>name",c).text(),uri:this.rawDoc.find("contributor>uri",c).text(),email:this.rawDoc.find("contributor>email",c).text()}},this).value();OPDS.Support.LinkSet.extract(this,"link");this.categories=this.rawDoc.find("category").map(function(c,d){return[$(d).attr("label"),$(d).attr("term")]});this.dcmetas={}},acquisitionLinks:function(){var a=/^http:\/\/opds-spec.org\/acquisition/;return _(this.links.by("rel")).chain().reject(function(b,c){return !c.match(a)}).flatten().value()},isPartial:function(){return _.any(this.links.by("rel")["alternate"],function(a){return a.type=="application/atom+xml"||a.type=="application/atom+xml;type=entry"})},completeLink:function(){if(this.isPartial()){return _.detect(this.links.by("rel")["alternate"],function(a){return a.type=="application/atom+xml;type=entry"||a.type=="application/atom+xml"})}return null},completeUrl:function(){if(this.completeLink()){return this.completeLink().url}return null},complete:function(a){if(this.completeLink()){return this.completeLink().navigate(a)}return null},inspect:function(){}});OPDS.Parser=_.Class({initialize:function(a){this.sniffedType=null;this.options=_.extend({},a)},parse:function(c,b){var a=this.__parseXML(c);this.sniffedType=this.__sniff(a);switch(this.sniffedType){case"acquisition":return new OPDS.AcquisitionFeed.fromJQuery(a,b);case"navigation":return new OPDS.NavigationFeed.fromJQuery(a,b);case"entry":return new OPDS.Entry.fromJQuery(a,b);default:return null}},__parseXML:function(a){if(window.ActiveXObject){doc=new ActiveXObject("Microsoft.XMLDOM");doc.async="false";doc.loadXML(a)}else{var b=new DOMParser();doc=b.parseFromString(a,"text/xml")}return $(doc)},__sniff:function(c){var b=c[0];if(b&&b.documentElement&&$.nodeName(b.documentElement,"entry")){return"entry"}else{var a=c.find("feed>entry");if(a.length>0){if(_(a).chain().toArray().all(function(d){return _($(d).find("link")).chain().toArray().any(function(f){var e=$(f).attr("rel");return _.isString(e)?e.match(/http:\/\/opds-spec.org\/acquisition/):false}).value()}).value()){return"acquisition"}return"navigation"}return null}}});OPDS.Support.Browser=_.Class({goTo:function(d,g){var c=new URI(d).toString();var b=this;this.lastResponse=null;this.currentLocation=c;try{$.get(c,function(i,e,h){b.lastResponse=h;g.apply(b,[b])})}catch(f){if(jQuery.browser.msie&&window.XDomainRequest){var a=new XDomainRequest();a.open("get",c);a.onload=function(){b.lastResponse=this;g.apply(b,[b])};a.send()}else{console.log("An error occured or your browser is to old for this...")}}},isOk:function(){return this.status()==200},status:function(){return this.lastResponse?this.lastResponse.status:null},headers:function(){return this.lastResponse?this.lastResponse.getAllResponseHeaders():null},body:function(){return this.lastResponse?this.lastResponse.responseText:null},discover:function(a,b){this.goTo(a,function(c){if(c.isOk()){var d={rawDoc:$(c.body())};OPDS.Support.LinkSet.extract(d,'[type="application/atom+xml;type=entry;profile=opds-catalog"], [type="application/atom+xml;profile=opds-catalog"]');if(d.links.size()==0){b.call(c,false)}b.call(c,d.links)}else{b.call(c,false)}})}});OPDS.Support.Link=_.Class({initialize:function(b,a){this.browser=a||new OPDS.Support.Browser();if(this.browser.currentLocation){b[1]=URI.join(this.browser.currentLocation,b[1]).toString()}this.rel=b[0]||null;this.url=b[1]||null;this.title=b[2]||null;this.type=b[3]||null;this.price=b[4]||null;this.currency=b[5]||null},navigate:function(a){return OPDS.Feed.parseUrl(this.url,a,this.browser)},inspect:function(){}});OPDS.Support.LinkSet=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser();this.length=0;this.store={rel_store:{},txt_store:{},lnk_store:{},typ_store:{}}},extend:{extract:function(a,b){a.links=new OPDS.Support.LinkSet(a.browser);a.rawDoc.find(b).each(function(d,h){var g=null,c=$(h);if(c.attr("title")){g=c.attr("title")}var f=c.attr("href");var e=c.attr("type")?c.attr("type"):null;if(c.attr("rel")){_.each(c.attr("rel").split(),function(i){a.links.push(i,f,g,e)})}else{a.links.push(null,f,g,e)}})}},set:function(b,e){var d=new OPDS.Support.Link([b].concat(e),this.browser);var c=this.store;var a=this.length;Array.prototype.push.apply(this,[d]);if(!c.rel_store[b]){c.rel_store[b]=[]}c.rel_store[b].push(a);if(!c.txt_store[e[1]]){c.txt_store[e[1]]=[]}c.txt_store[e[1]].push(a);if(!c.lnk_store[_.first(e)]){c.lnk_store[_.first(e)]=[]}c.lnk_store[_.first(e)].push(a);if(!c.typ_store[_.last(e)]){c.typ_store[_.last(e)]=[]}c.typ_store[_.last(e)].push(a)},get:function(a){return this.__remap(this.store.rel_store[a])},push:function(a,c,d,b){this.set(a,[c,d,b])},linkUrl:function(a){},linkRel:function(a){},linkText:function(a){},linkType:function(a){},by:function(a){var b={};_.each(this.__collection(a),function(d,c){return b[c]=this.__remap(d)},this);return b},links:function(){return _.keys(this.store.lnk_store)},rels:function(){return _.keys(this.store.rel_store)},texts:function(){return _.keys(this.store.txt_store)},inspect:function(){},first:function(){return _.first(this)},last:function(){return _.last(this)},__collection:function(a){switch(a){case"link":return this.store.lnk_store;case"rel":return this.store.rel_store;case"txt":return this.store.txt_store;case"type":return this.store.typ_store}},__remap:function(a){if(!a||a.length==0){return null}return _.map(a,function(b){return this[b]},this)}});OPDS.Feed=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser();this.rawDoc=null},extend:{parseUrl:function(c,e,b,d){var b=b||new OPDS.Support.Browser();var a=this;b.goTo(c,function(g){if(g.isOk()){var f=a.parseRaw(g.body(),d,g);if(f==null){var h=g.discover(g.currentLocation,function(){if(h.size>0){var i=h.get("related");if(i&&i.length>0){_.first(i).navigate(e)}}e.call(g,false)})}else{e.call(g,f)}}else{e.call(g,false)}})},parseRaw:function(a,c,b){var d=new OPDS.Parser(c);return d.parse(a,b)},fromJQuery:function(b,a){var c=new OPDS.Feed(a);c.rawDoc=b;c.serialize();return c}},serialize:function(){this.id=this.rawDoc.find("feed>id").text();this.icon=this.rawDoc.find("feed>icon").text();this.title=this.rawDoc.find("feed>title").text();this.author={name:this.rawDoc.find("feed>author>name").text(),uri:this.rawDoc.find("feed>author>uri").text(),email:this.rawDoc.find("feed>author>email").text()};this.entries=_(this.rawDoc.find("feed>entry")).chain().toArray().map(function(a){return OPDS.Entry.fromJQuery($(a),this.browser)},this).value();OPDS.Support.LinkSet.extract(this,"feed>link")},nextPageUrl:function(){},prevPageUrl:function(){},isPaginated:function(){},isFirstPage:function(){return this.isPaginated()?!this.prevPageUrl():false},isLastPage:function(){return this.isPaginated()?!this.nextPageUrl():false},nextPage:function(){return Feed.parseUrl(this.nextPageUrl(),this.browser)},prevPage:function(){return Feed.parseUrl(this.prevPageUrl(),this.browser)},inspect:function(){}});OPDS.NavigationFeed=_.Class(OPDS.Feed,{});OPDS.AcquisitionFeed=_.Class(OPDS.Feed,{});OPDS.Entry=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser();this.rawDoc=null},extend:{fromJQuery:function(b,a){var c=new OPDS.Entry(a);c.rawDoc=b;c.serialize();return c}},serialize:function(){if(this.rawDoc.find("entry").length==1){this.rawDoc=this.rawDoc.find("entry")}this.title=this.rawDoc.find("title").text()||null;this.id=this.rawDoc.find("id").text()||null;this.summary=this.rawDoc.find("summary").text()||null;this.content=this.rawDoc.find("content").text()||null;this.rights=this.rawDoc.find("rights").text()||null;this.subtitle=this.rawDoc.find("subtitle").text()||null;var b=this.rawDoc.find("updated").text();try{this.updated=Date.parse(b)}catch(a){this.updated=null}b=this.rawDoc.find("published").text();try{this.published=Date.parse(b)}catch(a){this.published=null}this.authors=_(this.rawDoc.find("author")).chain().toArray().map(function(c){return{name:this.rawDoc.find("author>name",c).text(),uri:this.rawDoc.find("author>uri",c).text(),email:this.rawDoc.find("author>email",c).text()}},this).value();this.author=_.first(this.authors);this.contributors=_(this.rawDoc.find("contributor")).chain().toArray().map(function(c){return{name:this.rawDoc.find("contributor>name",c).text(),uri:this.rawDoc.find("contributor>uri",c).text(),email:this.rawDoc.find("contributor>email",c).text()}},this).value();OPDS.Support.LinkSet.extract(this,"link");this.categories=this.rawDoc.find("category").map(function(c,d){return[$(d).attr("label"),$(d).attr("term")]});this.dcmetas={}},acquisitionLinks:function(){var a=/^http:\/\/opds-spec.org\/acquisition/;return _(this.links.by("rel")).chain().reject(function(b,c){return !c.match(a)}).flatten().value()},isPartial:function(){return _.any(this.links.by("rel")["alternate"],function(a){return a.type=="application/atom+xml"||a.type=="application/atom+xml;type=entry"})},completeLink:function(){if(this.isPartial()){return _.detect(this.links.by("rel")["alternate"],function(a){return a.type=="application/atom+xml;type=entry"||a.type=="application/atom+xml"})}return null},completeUrl:function(){if(this.completeLink()){return this.completeLink().url}return null},complete:function(a){if(this.completeLink()){return this.completeLink().navigate(a)}return null},inspect:function(){}});