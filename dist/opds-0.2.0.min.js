/*  opds-js JavaScript library, version 0.2.0
 *  (c) 2010 Paul Chavard
 *
 *  Released under MIT license.
 */
var OPDS={Support:{},access:function(a,b){return OPDS.Feed.parseUrl(a,b)}};
OPDS.Parser=_.Class({initialize:function(a){this.sniffedType=null;this.options=_.extend({},a)},parse:function(a,b){var d=this.__parseXML(a);this.sniffedType=this.__sniff(d);switch(this.sniffedType){case "acquisition":return new OPDS.AcquisitionFeed.fromJQuery(d,b);case "navigation":return new OPDS.NavigationFeed.fromJQuery(d,b);case "entry":return new OPDS.Entry.fromJQuery(d,b);default:return null}},__parseXML:function(a){if(window.ActiveXObject){doc=new ActiveXObject("Microsoft.XMLDOM");doc.async=
"false";doc.loadXML(a)}else doc=(new DOMParser).parseFromString(a,"text/xml");return $(doc)},__sniff:function(a){var b=a[0];if(b&&b.documentElement&&$.nodeName(b.documentElement,"entry"))return"entry";else{a=a.find("feed>entry");if(a.length>0){if(_(a).chain().toArray().all(function(d){return _($(d).find("link")).chain().toArray().any(function(c){c=$(c).attr("rel");return _.isString(c)?c.match(/http:\/\/opds-spec.org\/acquisition/):false}).value()}).value())return"acquisition";return"navigation"}return null}}});
OPDS.Entry=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser;this.rawDoc=null},extend:{fromJQuery:function(a,b){var d=new OPDS.Entry(b);d.rawDoc=a;d.serialize();return d}},serialize:function(){if(this.rawDoc.find("entry").length==1)this.rawDoc=this.rawDoc.find("entry");this.title=this.rawDoc.find("title").text()||null;this.id=this.rawDoc.find("id").text()||null;this.summary=this.rawDoc.find("summary").text()||null;this.content=this.rawDoc.find("content").text()||null;this.rights=
this.rawDoc.find("rights").text()||null;this.subtitle=this.rawDoc.find("subtitle").text()||null;var a=this.rawDoc.find("updated").text();try{this.updated=Date.parse(a)}catch(b){this.updated=null}a=this.rawDoc.find("published").text();try{this.published=Date.parse(a)}catch(d){this.published=null}this.authors=_(this.rawDoc.find("author")).chain().toArray().map(function(c){return{name:this.rawDoc.find("author>name",c).text(),uri:this.rawDoc.find("author>uri",c).text(),email:this.rawDoc.find("author>email",
c).text()}},this).value();this.author=_.first(this.authors);this.contributors=_(this.rawDoc.find("contributor")).chain().toArray().map(function(c){return{name:this.rawDoc.find("contributor>name",c).text(),uri:this.rawDoc.find("contributor>uri",c).text(),email:this.rawDoc.find("contributor>email",c).text()}},this).value();OPDS.Support.LinkSet.extract(this,"link");this.categories=this.rawDoc.find("category").map(function(c,f){return[$(f).attr("label"),$(f).attr("term")]});this.dcmetas={}},acquisitionLinks:function(){var a=
/^http:\/\/opds-spec.org\/acquisition/;return _(this.links.by("rel")).chain().reject(function(b,d){return!d.match(a)}).flatten().value()},isPartial:function(){return _.any(this.links.by("rel").alternate,function(a){return a.type=="application/atom+xml"||a.type=="application/atom+xml;type=entry"})},completeLink:function(){if(this.isPartial())return _.detect(this.links.by("rel").alternate,function(a){return a.type=="application/atom+xml;type=entry"||a.type=="application/atom+xml"});return null},completeUrl:function(){if(this.completeLink())return this.completeLink().url;
return null},complete:function(a){if(this.completeLink())return this.completeLink().navigate(a);return null},inspect:function(){}});
OPDS.Feed=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser;this.rawDoc=null},extend:{parseUrl:function(a,b,d,c){d=d||new OPDS.Support.Browser;var f=this;d.goTo(a,function(e){if(e.isOk()){var h=f.parseRaw(e.body(),c,e);if(h==null)var i=e.discover(e.currentLocation,function(){if(i.size>0){var g=i.get("related");g&&g.length>0&&_.first(g).navigate(b)}b.call(e,false)});else b.call(e,h)}else b.call(e,false)})},parseRaw:function(a,b,d){return(new OPDS.Parser(b)).parse(a,d)},fromJQuery:function(a,
b){var d=new OPDS.Feed(b);d.rawDoc=a;d.serialize();return d}},serialize:function(){this.id=this.rawDoc.find("feed>id").text();this.icon=this.rawDoc.find("feed>icon").text();this.title=this.rawDoc.find("feed>title").text();this.author={name:this.rawDoc.find("feed>author>name").text(),uri:this.rawDoc.find("feed>author>uri").text(),email:this.rawDoc.find("feed>author>email").text()};this.entries=_(this.rawDoc.find("feed>entry")).chain().toArray().map(function(a){return OPDS.Entry.fromJQuery($(a),this.browser)},
this).value();OPDS.Support.LinkSet.extract(this,"feed>link")},nextPageUrl:function(){},prevPageUrl:function(){},isPaginated:function(){},isFirstPage:function(){return this.isPaginated()?!this.prevPageUrl():false},isLastPage:function(){return this.isPaginated()?!this.nextPageUrl():false},nextPage:function(){return Feed.parseUrl(this.nextPageUrl(),this.browser)},prevPage:function(){return Feed.parseUrl(this.prevPageUrl(),this.browser)},inspect:function(){}});OPDS.NavigationFeed=_.Class(OPDS.Feed,{});
OPDS.AcquisitionFeed=_.Class(OPDS.Feed,{});
OPDS.Support.Browser=_.Class({goTo:function(a,b){var d=(new URI(a)).toString(),c=this;this.lastResponse=null;this.currentLocation=d;try{$.get(d,function(h,i,g){c.lastResponse=g;b.apply(c,[c])})}catch(f){if(jQuery.browser.msie&&window.XDomainRequest){var e=new XDomainRequest;e.open("get",d);e.onload=function(){c.lastResponse=this;b.apply(c,[c])};e.send()}else console.log("An error occured or your browser is to old for this...")}},isOk:function(){return this.status()==200},status:function(){return this.lastResponse?
this.lastResponse.status:null},headers:function(){return this.lastResponse?this.lastResponse.getAllResponseHeaders():null},body:function(){return this.lastResponse?this.lastResponse.responseText:null},discover:function(a,b){this.goTo(a,function(d){if(d.isOk()){var c={rawDoc:$(d.body())};OPDS.Support.LinkSet.extract(c,'[type="application/atom+xml;type=entry;profile=opds-catalog"], [type="application/atom+xml;profile=opds-catalog"]');c.links.size()==0&&b.call(d,false);b.call(d,c.links)}else b.call(d,
false)})}});OPDS.Support.Link=_.Class({initialize:function(a,b){this.browser=b||new OPDS.Support.Browser;if(this.browser.currentLocation)a[1]=URI.join(this.browser.currentLocation,a[1]).toString();this.rel=a[0]||null;this.url=a[1]||null;this.title=a[2]||null;this.type=a[3]||null;this.price=a[4]||null;this.currency=a[5]||null},navigate:function(a){return OPDS.Feed.parseUrl(this.url,a,this.browser)},inspect:function(){}});
OPDS.Support.LinkSet=_.Class({initialize:function(a){this.browser=a||new OPDS.Support.Browser;this.length=0;this.store={rel_store:{},txt_store:{},lnk_store:{},typ_store:{}}},extend:{extract:function(a,b){a.links=new OPDS.Support.LinkSet(a.browser);a.rawDoc.find(b).each(function(d,c){var f=null,e=$(c);if(e.attr("title"))f=e.attr("title");var h=e.attr("href"),i=e.attr("type")?e.attr("type"):null;e.attr("rel")?_.each(e.attr("rel").split(),function(g){a.links.push(g,h,f,i)}):a.links.push(null,h,f,i)})}},
set:function(a,b){var d=new OPDS.Support.Link([a].concat(b),this.browser),c=this.store,f=this.length;Array.prototype.push.apply(this,[d]);c.rel_store[a]||(c.rel_store[a]=[]);c.rel_store[a].push(f);c.txt_store[b[1]]||(c.txt_store[b[1]]=[]);c.txt_store[b[1]].push(f);c.lnk_store[_.first(b)]||(c.lnk_store[_.first(b)]=[]);c.lnk_store[_.first(b)].push(f);c.typ_store[_.last(b)]||(c.typ_store[_.last(b)]=[]);c.typ_store[_.last(b)].push(f)},get:function(a){return this.__remap(this.store.rel_store[a])},push:function(a,
b,d,c){this.set(a,[b,d,c])},linkUrl:function(){},linkRel:function(){},linkText:function(){},linkType:function(){},by:function(a){var b={};_.each(this.__collection(a),function(d,c){return b[c]=this.__remap(d)},this);return b},links:function(){return _.keys(this.store.lnk_store)},rels:function(){return _.keys(this.store.rel_store)},texts:function(){return _.keys(this.store.txt_store)},inspect:function(){},first:function(){return _.first(this)},last:function(){return _.last(this)},__collection:function(a){switch(a){case "link":return this.store.lnk_store;
case "rel":return this.store.rel_store;case "txt":return this.store.txt_store;case "type":return this.store.typ_store}},__remap:function(a){if(!a||a.length==0)return null;return _.map(a,function(b){return this[b]},this)}});
